---
title: "Initial_Explorations"
author: "Ana Miller-ter Kuile"
date: "5/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(here)
library(ggplot2)
library(MASS) #fitdistr function
library(fitdistrplus)
library(DHARMa)
library(glmmTMB)
```

# ASV tables

```{r}
ASV1 <- read.delim(here("data", "unoise_jan", "zotu_table_a.txt"), sep = '\t')
ASV1$X.OTU.ID <- as.character(ASV1$X.OTU.ID)

ASV2 <- read.delim(here("data", "unoise_jan", "zotu_table_b.txt"), sep = '\t')
ASV2$X.OTU.ID <- as.character(ASV2$X.OTU.ID)

ASV3 <- read.delim(here("data", "unoise_jan", "zotu_table_c.txt"), sep = '\t')
ASV3$X.OTU.ID <- as.character(ASV3$X.OTU.ID)

ASV4 <- read.delim(here("data", "unoise_jan", "zotu_table_d.txt"), sep = '\t')
ASV4$X.OTU.ID <- as.character(ASV4$X.OTU.ID)

ASV5 <- read.delim(here("data", "unoise_jan", "zotu_table_e.txt"), sep = '\t')
ASV5$X.OTU.ID <- as.character(ASV5$X.OTU.ID)

ASV6 <- read.delim(here("data", "unoise_jan", "zotu_table_f.txt"), sep = '\t')
ASV6$X.OTU.ID <- as.character(ASV6$X.OTU.ID)

ASV7 <- read.delim(here("data", "unoise_jan", "zotu_table_g.txt"), sep = '\t')
ASV7$X.OTU.ID <- as.character(ASV7$X.OTU.ID)

ASV8 <- read.delim(here("data", "unoise_jan", "zotu_table_h.txt"), sep = '\t')
ASV8$X.OTU.ID <- as.character(ASV8$X.OTU.ID)

ASV9 <- read.delim(here("data", "unoise_jan", "zotu_table_j.txt"), sep = '\t')
ASV9$X.OTU.ID <- as.character(ASV9$X.OTU.ID)

ASV10 <- read.delim(here("data", "unoise_jan", "zotu_table_k.txt"), sep = '\t')
ASV10$X.OTU.ID <- as.character(ASV10$X.OTU.ID)

ASV11 <- read.delim(here("data", "unoise_jan", "zotu_table_l.txt"), sep = '\t')
ASV11$X.OTU.ID <- as.character(ASV11$X.OTU.ID)

data <- ASV1 %>%
  left_join(ASV2, by = "X.OTU.ID") %>%
  left_join(ASV3, by = "X.OTU.ID") %>%
  left_join(ASV4, by = "X.OTU.ID") %>%
  left_join(ASV5, by = "X.OTU.ID") %>%
  left_join(ASV6, by = "X.OTU.ID") %>%
  left_join(ASV7, by = "X.OTU.ID") %>%
  left_join(ASV8, by = "X.OTU.ID") %>%
  left_join(ASV9, by = "X.OTU.ID") %>%
  left_join(ASV10, by = "X.OTU.ID") %>%
  left_join(ASV11, by = "X.OTU.ID") %>%
  rename("ASV" = "X.OTU.ID") %>%
  replace(., is.na(.), 0)

colnames(data)
colSums(data[,2:365])
```


```{r}
IDs_ncbi <- read.csv(here("data", "unoise_jan", "taxonomies", "NCBI", "ncbi_paths.csv"))

#set as factors
IDs_ncbi <- IDs_ncbi %>%
  mutate_if(is.factor, as.character)

#set an ID column based on the lowest taxonomic assignment
IDs_ncbi$ID_ncbi <- ifelse(IDs_ncbi$Species_ncbi != "", IDs_ncbi$Species_ncbi,
                           ifelse(IDs_ncbi$Genus_ncbi != "", IDs_ncbi$Genus_ncbi,
                                  ifelse(IDs_ncbi$Family_ncbi != "", IDs_ncbi$Family_ncbi,
                                         ifelse(IDs_ncbi$Order_ncbi != "", IDs_ncbi$Order_ncbi,
                                                ifelse(IDs_ncbi$Class_ncbi != "", IDs_ncbi$Class_ncbi,
                                                       ifelse(IDs_ncbi$Phylum_ncbi != "", IDs_ncbi$Phylum_ncbi, IDs_ncbi$Domain_ncbi))))))

#set a level at which the ID has been made
IDs_ncbi$ID_level_ncbi <- ifelse(IDs_ncbi$Species_ncbi != "", "Species",
                           ifelse(IDs_ncbi$Genus_ncbi != "", "Genus",
                                  ifelse(IDs_ncbi$Family_ncbi != "", "Family",
                                         ifelse(IDs_ncbi$Order_ncbi != "", "Order",
                                                ifelse(IDs_ncbi$Class_ncbi != "", "Class",
                                                       ifelse(IDs_ncbi$Phylum_ncbi != "", "Phylum", "Domain"))))))

#remove the weird thing that MEGAN puts in front of the ID in that column
#so that it is just the ID from that column
IDs_ncbi$ID_ncbi <- sapply(str_split(IDs_ncbi$ID_ncbi, "_"), function(x){return(x[[3]])})


bold1 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "01.csv"))
bold2 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "100.csv"))
bold3 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "200.csv"))
bold4 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "300.csv"))
bold5 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "400.csv"))
bold6 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "500.csv"))
bold7 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "600.csv"))
bold8 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "700.csv"))
bold9 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "800.csv"))
bold10 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "900.csv"))
bold11 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "1000.csv"))
bold12 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "1100.csv"))
bold13 <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "1200.csv"))

all_bold <- bold1 %>%
  bind_rows(bold2) %>%
  bind_rows(bold3) %>%
  bind_rows(bold4) %>%
  bind_rows(bold5) %>%
  bind_rows(bold6) %>%
  bind_rows(bold7) %>%
  bind_rows(bold8) %>%
  bind_rows(bold9) %>%
  bind_rows(bold10) %>%
  bind_rows(bold11) %>%
  bind_rows(bold12) %>%
  bind_rows(bold13) %>%
  filter(!Best.ID == "No match") %>%
  rename("ID_bold" = "Best.ID", "ZOTU" = "Query.ID") %>%
  dplyr::select(ID_bold, ZOTU)

#export so I can add taxonomic levels to this database
#write.csv(all_bold, here("data", "unoise_jan", "taxonomies", "BOLD", "bold.csv"))

#import after taxonomies are written
IDs_bold <- read.csv(here("data", "unoise_jan", "taxonomies", "BOLD", "bold.csv"))

#set as factors
IDs_bold <- IDs_bold %>%
  mutate_if(is.factor, as.character)

#set a level at which the ID has been made
IDs_bold$ID_level_bold <- ifelse(IDs_bold$Species_bold != "", "Species",
                           ifelse(IDs_bold$Genus_bold != "", "Genus",
                                  ifelse(IDs_bold$Family_bold != "", "Family",
                                         ifelse(IDs_bold$Order_bold != "", "Order",
                                                ifelse(IDs_bold$Class_bold != "", "Class", "Phylum")))))
                                                      

IDs <- IDs_ncbi %>%
  full_join(IDs_bold, by = "ZOTU") 
```

### These next are all trying to approach negatives like Chris Jerde, which is giving me some problems... I am going to ignore this bit for now and see what happens...

```{r}
pos <- data %>%
  dplyr::select(ASV, CL1a, CL1b, CL1c, CL1d, CL4a, CL4b, CL4c, CL4d, QC1a, QC1b, QC1c, QC1d)

neg <- data %>%
  dplyr::select(ASV, NEG2b, NEGa, NEGb, NEGc, NEGd) %>%
  replace(., is.na(.), 0)

```

```{r}
neg_long <- neg %>%
  gather(sample, reads, NEG2b:NEGd) %>%
  mutate(reads = replace_na(reads, 0))

ggplot(neg_long, aes(x = reads)) +
  geom_histogram() + facet_wrap(~sample)
```


```{r}
model_a <- glmmTMB(NEGa ~ 1,
                  family = "nbinom2",
                  data = neg)

simulate_nb <- simulateResiduals(fittedModel = model_a)
mod2fit <- plot(simulate_nb, asFactor=TRUE) 
mod2zi <- testZeroInflation(simulate_nb) 
mod2od <- testDispersion(simulate_nb)

model_b <- glmmTMB(NEGb ~ 1,
                  family = "nbinom2",
                  data = neg)

model_b2 <- glmmTMB(NEG2b ~ 1,
                  family = "nbinom2",
                  data = neg)

model_c <- glmmTMB(NEGc ~ 1,
                  family = "nbinom2",
                  data = neg)

#this one does not converge, and there is only one non-zero value of 1, so going to go ahead and say for this run, anything 1 or greater is REAL.
#model_d <- glmmTMB(NEGd ~ 1,
#                  family = "nbinom2",
#                  data = neg)


```

Negative controls look good except the one from run B (which was run with the Smeringopus samples - should I consider removing this many reads from just the SME samples? Or? Ask Austen)

```{r}
fitdistr(neg$NEGa, "negative binomial") #0.003776884, 0.986441340 
fitdistr(neg$NEGb, "negative binomial") # 0.003819531   0.132833327 
fitdistr(neg$NEG2b, "negative binomial") #0.004815162   57.545762712 
fitdistr(neg$NEGc, "negative binomial") #0.003043986   0.083461994 

#run A:
pnbinom(175, size = 0.003776884, mu = 0.986441340, lower = FALSE) #175 and lower is cutoff

#run B:
pnbinom(24, size = 0.003819531, mu = 0.132833327, lower = FALSE) #24 and lower
#this high negative is the negative from the SME samples, so maybe just reduce those? 
#seems judicious, and then just reduce all the others based on negative above?
pnbinom(9569, size = 0.004815162, mu = 57.545762712, lower = FALSE) #9569 and lower...

#run C:
pnbinom(16, size = 0.003043986 , mu = 0.083461994, lower = FALSE) #16 and lower
```

Positive controls look good!

```{r}
pos_long <- pos %>%
  gather(sample, reads, CL1a:QC1d) %>%
  mutate(reads = replace_na(reads, 0)) %>%
  filter(reads > 0)

ggplot(pos_long, aes(x = reads)) +
  geom_histogram() + facet_wrap(~sample) + scale_x_sqrt()
```

```{r}
#84
run1 <- data %>%
  dplyr::select(ASV, "HEV079a", "HEV081a", "HEV082a", "HEV083a", "HEV087a", "HEV088a", "HEV001", "HEV002", "HEV003", "HEV004", "HEV005", "HEV007a", "HEV010a", "HEV089a", "HEV011a", "HEV012a", "HEV013a", "HEV014a", "HEV015a", "HEV016a", "HEV017a", "HEV018a", "HEV020a", "HEV021a", "HEV022a", "HEV023a", "HEV024a", "HEV025a", "HEV026a", "HEV027a", "HEV029a", "HEV032", "HEV034", "HEV038", "HEV039", "HEV040", "HEV042", "HEV045", "HEV049", "HEV050", "HEV065a", "HEV066a", "HEV067a", "HEV068a", "HEV070a", "HEV071a", "HEV074a", "HEV076a", "NEO01", "NEO02", "NEO03", "NEO04", "NEO05", "NEO06", "NEO07", "NEO08", "NEO09", "NEO10", "NEO11", "NEO12", "NEO13", "NEO14", "NEO15", "NEO16", "NEO17", "NEO18", "NEO19", "NEO20", "NEO21", "NEO22", "NEO23", "NEO24", "NEO25", "NEO26", "SCY03", "SCY04", "SCY07", "SCY08", "SCY09", "SCY10", "SCY12", "SCY15", "SCY16", "SCY17") %>%
  replace(., is.na(.), 0)

#102
run2 <- data %>%
  dplyr::select(ASV, "CEN01", "CEN02", "CEN03", "CEN04", "CEN06", "CEN07", "CEN08", "CEN09", "CEN10", "CEN11", "CEN12", "CEN13", "CEN14", "CEN15", "CEN16", "CEN17", "HEV007b", "HEV010b", "HEV011b", "HEV012b", "HEV013b", "HEV014b", "HEV015b", "HEV016b", "HEV017b", "HEV018b", "HEV020b", "HEV021b", "HEV022b", "HEV023b", "HEV024b", "HEV025b", "HEV026b", "HEV027b", "HEV029b", "PHH004", "PHH005", "PHH006", "PHH007", "PHH008", "PHH009", "PHH010", "PHH016", "PHH020", "PHH021", "PHH022", "PHH023", "PHH024", "PHH025", "PHH030", "PHH032", "PHH034", "PHH035", "PHH038", "PHH039", "PHH040", "PHH041", "PHH042", "PHH043", "PHH044", "PHH045", "PHH046", "PHH047", "PHH049", "PHH050", "PHH051", "PHH052", "PHH053", "PHH054", "PHH055", "PHH056", "PHH057", "PHH058", "PHH059", "PHH060", "PHH061", "PHH062", "PHH063", "PHH065", "PHH066", "PHH067", "PHH068", "PHH069", "PHH070", "PHH071", "PHH072", "PHH073", "PHH074", "PHH075", "SME01", "SME02", "SME03", "SME05", "SME06", "SME07", "SME08", "SME09", "SME10", "SME11", "SME12", "SME13", "SME14") %>%
  replace(., is.na(.), 0)


#105
run3 <- data %>%
  dplyr::select(ASV, "EUB01", "EUB02", "EUB03", "EUB04", "EUB05", "EUB06", "EUB07", "EUB08", "EUB09", "EUB10", "EUB12", "EUB13", "EUB15", "EUB16", "EUB18", "EUB19", "EUB20", "EUB21", "EUB23", "EUB24", "EUB25", "EUB26", "EUB27", "EUB28", "EUB29", "EUB30", "EUB31", "EUB32", "EUB34", "EUB35", "EUB36", "HEV007c", "HEV010c", "HEV011c", "HEV012c", "HEV013c", "HEV014c", "HEV015c", "HEV016c", "HEV017c", "HEV018c", "HEV020c", "HEV021c", "HEV022c", "HEV023c", "HEV024c", "HEV025c", "HEV026c", "HEV027c", "HEV029c", "LRS2", "LRS3", "LRS5", "LRS6",  "ISO01", "ISO02", "ISO04", "ISO05", "ISO06", "ISO07", "ISO08", "ISO09", "ISO10", "ISO11", "ISO12", "ISO13", "ISO14", "ISO15", "ISO16", "ISO17", "ISO18", "ISO19", "ISO20", "ISO21", "ISO22", "ISO23", "ISO24", "ISO25", "ISO26", "ISO27", "ISO30", "ISO31", "ISO32", "ISO33", "ISO34", "ISO35", "ISO36", "ISO37", "LRS7", "LRS8", "PAN01", "PAN02", "PAN03", "PAN04", "PAN05", "PAN06", "PAN07", "PAN08", "PAN09", "PAN10", "PAN11", "PAN12", "PAN13", "PAN14", "PAN15") %>%
  replace(., is.na(.), 0)

#56
run4 <- data %>%
  dplyr::select(ASV,  "HEV079d", "HEV081d", "HEV082d", "HEV083d", "HEV087d", "HEV007d","HEV089d", "HEV088d", "HEV010d", "HEV011d", "HEV012d", "HEV013d", "HEV014d", "HEV015d", "HEV016d", "HEV017d", "HEV018d", "HEV020d", "HEV021d", "HEV022d", "HEV023d", "HEV024d", "HEV025d", "HEV026d", "HEV027d", "HEV029d", "HEV065d", "HEV066d", "HEV067d", "HEV068d", "HEV070d", "HEV071d", "HEV074d", "HEV076d", "HEV099", "HEV100", "HEV101", "HEV102", "HEV103", "HEV104", "HEV105", "HEV106", "HEV107", "HEV108", "HEV109", "HEV110", "HEV111", "HEV090", "HEV091", "HEV092", "HEV093", "HEV094", "HEV095", "HEV096", "HEV097", "HEV098") %>%
  replace(., is.na(.), 0)
```

```{r}
#run A:
#175 and lower is cutoff
a_real <- run1 %>%
  gather(sample, reads, HEV079a:SCY17) %>%
  filter(reads > 175)

#run B:
#24 and lower
run2_a <- run2 %>%
  dplyr::select(ASV, "CEN01", "CEN02", "CEN03", "CEN04", "CEN06", "CEN07", "CEN08", "CEN09", "CEN10", "CEN11", "CEN12", "CEN13", "CEN14", "CEN15", "CEN16", "CEN17", "HEV007b", "HEV010b", "HEV011b", "HEV012b", "HEV013b", "HEV014b", "HEV015b", "HEV016b", "HEV017b", "HEV018b", "HEV020b", "HEV021b", "HEV022b", "HEV023b", "HEV024b", "HEV025b", "HEV026b", "HEV027b", "HEV029b", "PHH004", "PHH005", "PHH006", "PHH007", "PHH008", "PHH009", "PHH010", "PHH016", "PHH020", "PHH021", "PHH022", "PHH023", "PHH024", "PHH025", "PHH030", "PHH032", "PHH034", "PHH035", "PHH038", "PHH039", "PHH040", "PHH041", "PHH042", "PHH043", "PHH044", "PHH045", "PHH046", "PHH047", "PHH049", "PHH050", "PHH051", "PHH052", "PHH053", "PHH054", "PHH055", "PHH056", "PHH057", "PHH058", "PHH059", "PHH060", "PHH061", "PHH062", "PHH063", "PHH065", "PHH066", "PHH067", "PHH068", "PHH069", "PHH070", "PHH071", "PHH072", "PHH073", "PHH074", "PHH075")

ba_real <- run2_a %>%
  gather(sample, reads, CEN01:PHH075) %>%
  filter(reads > 24)

#9569 and lower for SME
run2_b <- run2 %>%
  dplyr::select(ASV, "SME01", "SME02", "SME03", "SME05", "SME06", "SME07", "SME08", "SME09", "SME10", "SME11", "SME12", "SME13", "SME14")

bb_real <- run2_b %>%
  gather(sample, reads, SME01:SME14) %>%
  filter(reads > 9569)

#run C:
#16 and lower
c_real <- run3 %>%
  gather(sample, reads, EUB01:PAN15) %>%
  filter(reads > 16)

```


